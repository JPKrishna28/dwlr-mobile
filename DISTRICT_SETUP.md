# Multi-District Database Setup Guide

This guide explains how to set up multiple district monitoring stations in your Groundwater Insights app.

## Overview

The app now supports multiple district monitoring stations, each with its own database table. When a user selects a district, the app will query the corresponding table for that district's data.

## Current Configuration

The app is configured to support these district monitoring stations:

### Krishna District
- **Table Name:** `water_levels`
- **Description:** Krishna District monitoring station  
- **Icon:** üèûÔ∏è (Landscape)
- **Color:** Blue (#2563eb)

### Eluru District
- **Table Name:** `water_levels2`
- **Description:** Eluru District monitoring station
- **Icon:** üåæ (Rice fields)
- **Color:** Green (#059669)

## Database Setup

### Step 1: Create the Eluru District Table

You need to create a new table for Eluru District data. Run this SQL in your Supabase SQL editor:

```sql
-- Create table for Eluru District data
CREATE TABLE water_levels2 (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    timestamp TIMESTAMPTZ DEFAULT NOW(),
    water_level NUMERIC,
    pressure NUMERIC,
    temperature NUMERIC,
    battery_level NUMERIC,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Enable Row Level Security
ALTER TABLE water_levels2 ENABLE ROW LEVEL SECURITY;

-- Create policies for authenticated users
CREATE POLICY "Enable read access for authenticated users" ON water_levels2
    FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Enable insert access for authenticated users" ON water_levels2
    FOR INSERT WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "Enable update access for authenticated users" ON water_levels2
    FOR UPDATE USING (auth.role() = 'authenticated');

-- Enable real-time subscriptions
ALTER PUBLICATION supabase_realtime ADD TABLE water_levels2;
```

### Step 2: Insert Sample Data for Eluru District (Optional)

To test the district selection feature, you can insert some sample data:

```sql
-- Insert sample data for Eluru District
INSERT INTO water_levels2 (water_level, pressure, temperature, battery_level) VALUES
    (12.3, 118.5, 22.1, 88.0),
    (12.1, 117.8, 22.3, 87.5),
    (12.5, 119.2, 21.9, 87.0),
    (12.2, 118.1, 22.2, 86.5),
    (12.4, 118.8, 22.0, 86.0);
```

## Adding More Districts

To add additional district monitoring stations, follow these steps:

### 1. Update CitySelectionScreen.js

Add new district objects to the `availableCities` array:

```javascript
const availableCities = [
    {
      id: 'krishna',
      name: 'Krishna District',
      tableName: 'water_levels',
      description: 'Krishna District monitoring station',
      icon: 'üèûÔ∏è',
      color: '#2563eb',
    },
    {
      id: 'eluru',
      name: 'Eluru District',
      tableName: 'water_levels2',
      description: 'Eluru District monitoring station',
      icon: 'üåæ',
      color: '#059669',
    },
    // Add new district here:
    {
      id: 'guntur',
      name: 'Guntur District',
      tableName: 'water_levels3',
      description: 'Guntur District monitoring station',
      icon: 'üå±',
      color: '#7c3aed',
    },
];
```

### 2. Create Database Table

Create a new table for each additional district:

```sql
-- Replace 'guntur' and 'water_levels3' with your district identifier
CREATE TABLE water_levels3 (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    timestamp TIMESTAMPTZ DEFAULT NOW(),
    water_level NUMERIC,
    pressure NUMERIC,
    temperature NUMERIC,
    battery_level NUMERIC,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Enable RLS and policies
ALTER TABLE water_levels3 ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Enable read access for authenticated users" ON water_levels3
    FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Enable insert access for authenticated users" ON water_levels3
    FOR INSERT WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "Enable update access for authenticated users" ON water_levels3
    FOR UPDATE USING (auth.role() = 'authenticated');

ALTER PUBLICATION supabase_realtime ADD TABLE water_levels3;
```

## How It Works

### District Selection Process

1. **App Launch:** User sees district selection screen with Krishna and Eluru options
2. **Table Detection:** App checks which district tables exist in the database
3. **District Selection:** User selects their district (Krishna or Eluru)
4. **Data Loading:** App switches to the selected district's table
5. **Real-time Updates:** App subscribes to changes for that district's table only

### Data Isolation

- Each district has its own table (`water_levels` for Krishna, `water_levels2` for Eluru)
- Data is completely isolated between districts
- Real-time subscriptions are district-specific
- Charts and lists show data only from selected district

### User Experience

- Users must select a district before viewing data
- District selection is persistent during the session
- Users can switch districts using the button in the header
- Visual indicators show which district is currently selected

## District Table Mapping

| District | Table Name | Icon | Description |
|----------|------------|------|-------------|
| Krishna | `water_levels` | üèûÔ∏è | Original table for Krishna District |
| Eluru | `water_levels2` | üåæ | New table for Eluru District |

## Troubleshooting

### District Not Appearing

If a district doesn't appear in the selection screen:

1. Check that the table exists in your database
2. Verify that the user has read permissions on the table
3. Ensure the table name in `availableCities` matches exactly
4. Check browser console for error messages

### Data Not Loading

If data doesn't load after selecting a district:

1. Verify the table has data
2. Check Row Level Security policies
3. Ensure the user is authenticated
4. Verify real-time subscriptions are enabled

### Real-time Updates Not Working

If real-time updates aren't working:

1. Check that the table is added to `supabase_realtime` publication
2. Verify the user has the necessary permissions
3. Ensure the subscription channel name is unique per table

## Security Considerations

### Row Level Security (RLS)

- All tables have RLS enabled
- Only authenticated users can access data
- Consider adding district-specific user roles if needed

### Data Access Control

- Users currently see all available districts
- To restrict access, modify the `availableCities` array based on user roles
- Implement server-side filtering if needed

## Performance Notes

- Tables are queried independently
- Real-time subscriptions are established per selected district
- Consider indexing timestamp columns for better performance:

```sql
CREATE INDEX idx_water_levels2_timestamp ON water_levels2 (timestamp);
```

## Future Enhancements

### Possible Improvements

1. **Dynamic District Discovery:** Auto-detect tables that follow naming pattern
2. **User-Specific Districts:** Show only districts user has access to
3. **District Management:** Admin interface for adding/removing districts
4. **Data Aggregation:** Cross-district comparison views
5. **Geolocation Integration:** Map-based district selection

### Configuration Management

Consider moving district configuration to:
- Environment variables
- Database configuration table
- External configuration service
- User preferences system

## Quick Setup Commands

```sql
-- Complete setup for Eluru District
CREATE TABLE water_levels2 (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    timestamp TIMESTAMPTZ DEFAULT NOW(),
    water_level NUMERIC,
    pressure NUMERIC,
    temperature NUMERIC,
    battery_level NUMERIC,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE water_levels2 ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Enable read access for authenticated users" ON water_levels2
    FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Enable insert access for authenticated users" ON water_levels2
    FOR INSERT WITH CHECK (auth.role() = 'authenticated');

ALTER PUBLICATION supabase_realtime ADD TABLE water_levels2;

-- Add some test data
INSERT INTO water_levels2 (water_level, pressure, temperature, battery_level) 
VALUES (12.3, 118.5, 22.1, 88.0);
```

Your Groundwater Insights app now supports Krishna and Eluru district monitoring stations! üèûÔ∏èüåæ
