# Multi-City Database Setup Guide

This guide explains how to set up multiple monitoring stations (cities) in your Groundwater Insights app.

## Overview

The app now supports multiple monitoring stations, each with its own database table. When a user selects a city, the app will query the corresponding table for that city's data.

## Current Configuration

The app is configured to support these monitoring stations:

### City 1 (Primary Station)
- **Table Name:** `water_levels`
- **Description:** Primary monitoring station
- **Icon:** üèôÔ∏è
- **Color:** Blue (#2563eb)

### City 2 (Secondary Station)
- **Table Name:** `water_levels2`
- **Description:** Secondary monitoring station
- **Icon:** üåÜ
- **Color:** Green (#059669)

## Database Setup

### Step 1: Create the Second City Table

You need to create a new table for City 2 data. Run this SQL in your Supabase SQL editor:

```sql
-- Create table for City 2 data
CREATE TABLE water_levels2 (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    timestamp TIMESTAMPTZ DEFAULT NOW(),
    water_level NUMERIC,
    pressure NUMERIC,
    temperature NUMERIC,
    battery_level NUMERIC,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Enable Row Level Security
ALTER TABLE water_levels2 ENABLE ROW LEVEL SECURITY;

-- Create policies for authenticated users
CREATE POLICY "Enable read access for authenticated users" ON water_levels2
    FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Enable insert access for authenticated users" ON water_levels2
    FOR INSERT WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "Enable update access for authenticated users" ON water_levels2
    FOR UPDATE USING (auth.role() = 'authenticated');

-- Enable real-time subscriptions
ALTER PUBLICATION supabase_realtime ADD TABLE water_levels2;
```

### Step 2: Insert Sample Data (Optional)

To test the city selection feature, you can insert some sample data:

```sql
-- Insert sample data for City 2
INSERT INTO water_levels2 (water_level, pressure, temperature, battery_level) VALUES
    (15.5, 125.0, 18.5, 85.0),
    (15.3, 124.5, 18.7, 84.0),
    (15.7, 125.8, 18.2, 83.5),
    (15.4, 124.9, 18.6, 82.0),
    (15.6, 125.3, 18.4, 81.5);
```

## Adding More Cities

To add additional monitoring stations, follow these steps:

### 1. Update CitySelectionScreen.js

Add new city objects to the `availableCities` array:

```javascript
const availableCities = [
    {
      id: 'city1',
      name: 'City 1',
      tableName: 'water_levels',
      description: 'Primary monitoring station',
      icon: 'üèôÔ∏è',
      color: '#2563eb',
    },
    {
      id: 'city2',
      name: 'City 2',
      tableName: 'water_levels2',
      description: 'Secondary monitoring station',
      icon: 'üåÜ',
      color: '#059669',
    },
    // Add new city here:
    {
      id: 'city3',
      name: 'City 3',
      tableName: 'water_levels_city3',
      description: 'Third monitoring station',
      icon: 'üåÉ',
      color: '#7c3aed',
    },
];
```

### 2. Create Database Table

Create a new table for each additional city:

```sql
-- Replace 'city3' with your city identifier
CREATE TABLE water_levels_city3 (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    timestamp TIMESTAMPTZ DEFAULT NOW(),
    water_level NUMERIC,
    pressure NUMERIC,
    temperature NUMERIC,
    battery_level NUMERIC,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Enable RLS and policies
ALTER TABLE water_levels_city3 ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Enable read access for authenticated users" ON water_levels_city3
    FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Enable insert access for authenticated users" ON water_levels_city3
    FOR INSERT WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "Enable update access for authenticated users" ON water_levels_city3
    FOR UPDATE USING (auth.role() = 'authenticated');

ALTER PUBLICATION supabase_realtime ADD TABLE water_levels_city3;
```

## How It Works

### City Selection Process

1. **App Launch:** User sees city selection screen
2. **Table Detection:** App checks which tables exist in the database
3. **City Selection:** User selects their monitoring station
4. **Data Loading:** App switches to the selected city's table
5. **Real-time Updates:** App subscribes to changes for that table only

### Data Isolation

- Each city has its own table
- Data is completely isolated between cities
- Real-time subscriptions are table-specific
- Charts and lists show data only from selected city

### User Experience

- Users must select a city before viewing data
- City selection is persistent during the session
- Users can switch cities using the button in the header
- Visual indicators show which city is currently selected

## Troubleshooting

### City Not Appearing

If a city doesn't appear in the selection screen:

1. Check that the table exists in your database
2. Verify that the user has read permissions on the table
3. Ensure the table name in `availableCities` matches exactly
4. Check browser console for error messages

### Data Not Loading

If data doesn't load after selecting a city:

1. Verify the table has data
2. Check Row Level Security policies
3. Ensure the user is authenticated
4. Verify real-time subscriptions are enabled

### Real-time Updates Not Working

If real-time updates aren't working:

1. Check that the table is added to `supabase_realtime` publication
2. Verify the user has the necessary permissions
3. Ensure the subscription channel name is unique per table

## Security Considerations

### Row Level Security (RLS)

- All tables have RLS enabled
- Only authenticated users can access data
- Consider adding city-specific user roles if needed

### Data Access Control

- Users currently see all available cities
- To restrict access, modify the `availableCities` array based on user roles
- Implement server-side filtering if needed

## Performance Notes

- Tables are queried independently
- Real-time subscriptions are established per selected city
- Consider indexing timestamp columns for better performance:

```sql
CREATE INDEX idx_water_levels2_timestamp ON water_levels2 (timestamp);
```

## Future Enhancements

### Possible Improvements

1. **Dynamic City Discovery:** Auto-detect tables that follow naming pattern
2. **User-Specific Cities:** Show only cities user has access to
3. **City Management:** Admin interface for adding/removing cities
4. **Data Aggregation:** Cross-city comparison views
5. **Geolocation Integration:** Map-based city selection

### Configuration Management

Consider moving city configuration to:
- Environment variables
- Database configuration table
- External configuration service
- User preferences system
